<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ModelVault Viewer</title>
  <style>
    body { font-family: sans-serif; }
    ul { list-style: none; padding: 0; }
    li { padding: 5px; cursor: pointer; }
    li.folder { font-weight: bold; color: darkgreen; }
    li.file { color: blue; }
    #backBtn { margin-bottom: 10px; display:none; }
  </style>
</head>
<body>
  <h1>Dropbox ファイル一覧</h1>
  <button id="backBtn">戻る</button>
  <ul id="file-list"></ul>
  <video id="videoPlayer" width="640" height="360" controls style="display:none; margin-top:1em;"></video>

  <script>
    const ACCESS_TOKEN = "sl.u.AGAYjtF4vzsn2WA1iYcLtMmkZ1SNdB46P77UEFPf0_ssA9r5St6C9GPw13Tpn6JKsN1fQkfIGAthgqdmv9sdQXc5bf--4sTwzm-RCCKQ4liNtHAIXVCcVmK0dBuK5Ez6Qu5SXC9x4jqMx3n5DBiwfpCy6DhrqzpWEmBGRayEZbosV1dae_ETWHE7qcD0bLgPiBiIG8vQVjhmV_j-NbAVeia-PQCmQyocMcRJ6apTeDFYY2skMbTYgJfmkouOBE5cDLLEEInyQhIj3yUwssx6LUMpzTa2R2hrQuuXhC4CmNhrZS2gkoUtg1mi89wAPQaz44kBCGe-_s8c7dNEyRaepxezdCuCQgqLicnUZvCFd6a8abKdsNDE1wqNqyV1TcL6US6uHauEXlzp5Upip6xmtzFL3r5Dbnz9hgUduxxM4MKBMKgXH_jSgzURqcBY6oWzYAiK_v0EcGOq7sQUPq99787yaUmu3tFWELCOWk8K6KozlqPNOG6rjCPe0xOfFWR7IhMlcBny-WoY1bkOVVN8NIKQjuT4YNEL0Rr4nz_J6HZIvxr04_mfTiHsaghotlnRpTcg3zCDGD-7g6GSi-g0uzfyurgkJjld4pWtpIaZHMcSbF2ABe7SmsazBhQqBMcZhr8T31FA1kE8qBSNbfWHSv8xUd0P8Foj8VROMmRmwwyXb8FPM7GGF4ji7Hwqztir4n38bLrnfm4dv0A_Xf5R8zxcpfe35FQBxYBPMTEgdClowjaH9Nyz_nm25-sgp75X0GRKYlTgzjNewwTjER9uvqrUya4GOQGD37yjf1NM9akdso5cqHyJ-kTY6qWZpZhQnsMb_WichvzK8Utw5XPILvtygAiBd5GmjIqSk0FSKAoLS7x2RoXQjpe6Vzu0sYBVd0surBkp2Dg_L6vy32dwB8UOaNojBokQcRrfCApQVUozSKXRMgE6kHGj3I0kLGJobtxWymQ6Ww3qfXPoSmMMhbrYb_NidFb6Po8mWBVOY5jrYgU0DjpUBoKg3kmokxvq-Qioxsy6i7OX7ovTIf3tk2XtLky0EWxpIe0Op0-Hb9tMjpYuZlsCCi2Axaubazh-aAk8JCFzS54QkyYNpyGLY5YTEOVl09oBcZ0S1kWL0hNfzvXUWMHeCCtpmnq38r_LoIiRvpp5m-vHynTx2s7SNrxAALx-2-xS03MucSZgM_Lp0zNuNHqWWUNPz7y1lAiP3rG0HMVA9p0zHfV0_sQKYkVadufhu7gQQQDyoV-fteJsP7OYg2wMIzSDXAEWCHrMjKI"; 
    const LIST_API = "https://api.dropboxapi.com/2/files/list_folder";
    const TEMP_LINK_API = "https://api.dropboxapi.com/2/files/get_temporary_link";

    // 📂 現在のパスを管理（戻る機能用）
    let pathHistory = [];

    async function fetchFiles(path = "") {
      // ✅ フォルダを開いたら動画を止める
      const videoPlayer = document.getElementById("videoPlayer");
      videoPlayer.pause();
      videoPlayer.src = "";
      videoPlayer.style.display = "none";

      const response = await fetch(LIST_API, {
        method: "POST",
        headers: {
          "Authorization": "Bearer " + ACCESS_TOKEN,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ path })
      });
      const data = await response.json();

      const list = document.getElementById("file-list");
      list.innerHTML = ""; // 前回のリストをクリア

      // 戻るボタンの表示制御
      const backBtn = document.getElementById("backBtn");
      backBtn.style.display = pathHistory.length > 0 ? "inline-block" : "none";

      data.entries.forEach(entry => {
        const li = document.createElement("li");
        li.textContent = entry.name;

        if(entry[".tag"] === "folder") {
          li.classList.add("folder");
          li.onclick = () => {
            pathHistory.push(path); // 現在のパスを記録
            fetchFiles(entry.path_lower);
          };
        } else if(entry[".tag"] === "file" && entry.name.endsWith(".mp4")) {
          li.classList.add("file");
          li.onclick = () => playVideo(entry.path_lower);
        }

        list.appendChild(li);
      });
    }

    async function playVideo(path) {
      const response = await fetch(TEMP_LINK_API, {
        method: "POST",
        headers: {
          "Authorization": "Bearer " + ACCESS_TOKEN,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ path })
      });

      const data = await response.json();
      const videoUrl = data.link;

      const videoPlayer = document.getElementById("videoPlayer");
      videoPlayer.src = videoUrl;
      videoPlayer.style.display = "block";
      videoPlayer.play();
    }

    // 戻るボタンの処理
    document.getElementById("backBtn").onclick = () => {
      if (pathHistory.length > 0) {
        const prevPath = pathHistory.pop(); // 一つ前のパスを取り出す
        fetchFiles(prevPath);
      }
    };

    // 初回呼び出し（ルートフォルダ表示）
    fetchFiles();
  </script>
</body>
</html>