<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ModelVault Viewer</title>
  <style>
    body { font-family: sans-serif; }
    ul { list-style: none; padding: 0; }
    li { padding: 5px; cursor: pointer; }
    li.folder { font-weight: bold; color: darkgreen; }
    li.file { color: blue; }
    #backBtn { margin-bottom: 10px; display:none; }
  </style>
</head>
<body>
  <h1>Dropbox ファイル一覧</h1>
  <button id="backBtn">戻る</button>
  <ul id="file-list"></ul>
  <video id="videoPlayer" width="640" height="360" controls style="display:none; margin-top:1em;"></video>

  <script>
    const ACCESS_TOKEN = "sl.u.AGBibKwRoZ8kR1UPZTGGMWNwBZ_hhHaxFegaflj56gBxH7q3f5o1N-2lf90vJbvt5Gq7xYl_VPAUtrK4cStzsbh7WQ2OaLFtGQk1Nli0zIdNP55H2wieZBuwPQfY2RnNBvCeWNQU7Kmhte-LfQrgnniD74dCszTGF9SSEtErSyeFmQLIsItFvqfcbwkCwsXy3xHXY55yNk7qv8HWz3ra7ol6IHnWhjovM7B3c4HKFDODa5kvz4LrsQslCSCVZ6ub7NqlSukbnPL7a3ELAHwSfSuhXLr1xbbZnJOwYVj95G1LqWqKa8gLs_Ne7lHbTvKyyYZL8zOJBBrMPbdyfeh6nEw1yY--yhxIus_xLIw9WoR6pLusiY5l4N55EuvRwYh6sBPjYFKcoSkGHlRAdCnMldhcPpPbpgthMVo5NItXnsTfMPvt9HQyAxqj7c8AaqomthAuOPoS8lOw1yv2xLa8WB3EVWdt7TuO9IMdg2HmaqW_pbxEVMhk2EhA1-BznEAfcrVRnl56a67llcGovjhhoy_62z0u6JaIoY5sMfSfcnUIjvc1V6ZSaeuQd-TlQHKsa-GNH5cq-GiQV-ZEPz5NDPSdPg3g7fsowpZpu9vsQciq9_-RdjHOicFOcn8YeDC4_wutQm_Sik48WNOum6w7qEEShPB7xiPiiDx1Gt8x_hueyGqNJJoHFg2Muutq4MR9Hzwg55aP86vVWhW3IQdafnaTQatn06o7vgqs0jOKGVGrVr52AzKLI8A8CODLRWJBUzDW0kzyJSSQ20r8wWXSkONnURThErzOh1TSnpUKEBFkwTeRZEMBEnUkcLq92V9_uUiWapxLJ0-aUpTH-gKjRqX13NenX0dI4dbkLavQQg3DQWIragB28xOkK3AnF-6DmNQOyKhaOjL863-7WQYpeGRTT1SyATJekDzsZlj7abSFVrffaWv7H6eiglEyeUtSkmJkMW00e0iUF60N3c5_6yuJ2a5dnZ-eIO0zqXYyYHpjXL2J_royWmAFi3CX92UB15EWa_VDv8gz5zFIottJJKcIY9l5yk9ywg40mbKLcmntmNLo8uS1KuW2-2rng8D8xXvL2-0518Get7ukRk72jT_FnRbT9ddwr0JgZI9zv1tok4q_7RdLJxwgYQBIVhzsvn_WA_mL0DgbfTJPfcvAw3XJh6qXP0bpFaZ7oMUCHvO0MgD90rvxyXNn8B7aTQDvv9O0_LSOOepJzSAHUYtwQBhO4FMf7A5gxfXd_ppjr61BQ67OpayuZxP1sRa6YEXLxhK-iPcMCcnmfTnC5USKO5Ec"; 
    const LIST_API = "https://api.dropboxapi.com/2/files/list_folder";
    const TEMP_LINK_API = "https://api.dropboxapi.com/2/files/get_temporary_link";

    // 📂 現在のパスを管理（戻る機能用）
    let pathHistory = [];

    async function fetchFiles(path = "") {
      // ✅ フォルダを開いたら動画を止める
      const videoPlayer = document.getElementById("videoPlayer");
      videoPlayer.pause();
      videoPlayer.src = "";
      videoPlayer.style.display = "none";

      const response = await fetch(LIST_API, {
        method: "POST",
        headers: {
          "Authorization": "Bearer " + ACCESS_TOKEN,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ path })
      });
      const data = await response.json();

      const list = document.getElementById("file-list");
      list.innerHTML = ""; // 前回のリストをクリア

      // 戻るボタンの表示制御
      const backBtn = document.getElementById("backBtn");
      backBtn.style.display = pathHistory.length > 0 ? "inline-block" : "none";

      data.entries.forEach(entry => {
        const li = document.createElement("li");
        li.textContent = entry.name;

        if(entry[".tag"] === "folder") {
          li.classList.add("folder");
          li.onclick = () => {
            pathHistory.push(path); // 現在のパスを記録
            fetchFiles(entry.path_lower);
          };
        } else if(entry[".tag"] === "file" && entry.name.endsWith(".mp4")) {
          li.classList.add("file");
          li.onclick = () => playVideo(entry.path_lower);
        }

        list.appendChild(li);
      });
    }

    async function playVideo(path) {
      const response = await fetch(TEMP_LINK_API, {
        method: "POST",
        headers: {
          "Authorization": "Bearer " + ACCESS_TOKEN,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ path })
      });

      const data = await response.json();
      const videoUrl = data.link;

      const videoPlayer = document.getElementById("videoPlayer");
      videoPlayer.src = videoUrl;
      videoPlayer.style.display = "block";
      videoPlayer.play();
    }

    // 戻るボタンの処理
    document.getElementById("backBtn").onclick = () => {
      if (pathHistory.length > 0) {
        const prevPath = pathHistory.pop(); // 一つ前のパスを取り出す
        fetchFiles(prevPath);
      }
    };

    // 初回呼び出し（ルートフォルダ表示）
    fetchFiles();
  </script>
</body>
</html>
