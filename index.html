<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>AIãƒ¢ãƒ‡ãƒ«ä¸€è¦§</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: sans-serif; margin: 2em; }
    .file-list { list-style: none; padding: 0; }
    .file-list li { margin: 0.4em 0; }
    a { color: blue; text-decoration: none; cursor: pointer; }
    .folder { font-weight: 700; }
    .controls { margin-bottom: 1em; }
    .breadcrumb { font-size: 0.9em; color: #333; margin-bottom: 0.5em; }
    .small { font-size: 0.9em; color: #666; margin-left: 0.5em; }
  </style>
</head>
<body>
  <h1>Dropbox ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§</h1>
  <div class="controls">
    <button id="up-btn">â†‘ è¦ªãƒ•ã‚©ãƒ«ãƒ€ã¸</button>
    <span id="current-path" class="breadcrumb">/</span>
  </div>
  <ul id="file-list" class="file-list"></ul>

  <script>
    // å–å¾—ã—ãŸDropboxãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆä¾‹ã¨ã—ã¦åŸ‹ã‚ã¦ã„ã¾ã™ãŒã€å…¬é–‹ã‚µã‚¤ãƒˆã«ç›´æ¥è¼‰ã›ã‚‹ã®ã¯å±é™ºã§ã™ï¼‰
    const ACCESS_TOKEN = "sl.u.AF_xPiKNn_PhpPwDIuAKCXxetvgfkizlxi3HNNOUdlQVp7WZvZ9kCiJGqd12m5OU1ZTSlFcJksOJz3-oxVYD471cYF53crXj7P2VpHm4oHn3Ct45HA4WZExDO1eDLrp9lQM5HpxTLSkDrOf84ISxtJGQuauqtrkLBmtBNiPL6DPh106R8y56RgZlRkmS5EfHnKqlynRELE0lUu80v94RWbc1GDX-0prFu74KP2Rzyn7EFjne4CdYLLu4Urx_UeUcYKq2hrS7ztq78IxQ3a2vfgIdS_WW_NNEL2-S5QR0btI8vKxIghKVzUojJ9BpQmxeKkA5Uppc--cLzsnpgaFo720hpHLi16O0eDWCW82LlaV4bUbiuIdOMKX2tEEVo5LNCHd9vBqxuywRiqC1rRFo6eBqKYUAk-YyC2UfbTLbWRvs-EZYJ-s0Y_StYT58QOexh5-GkpZoZY-5pSkwrqyxuHNxKQERdj5Ur1D0nxEn315PtbUiasYTvJwNFpBFdWeJTNTcGG80mPyBsNz2QbW3AZsr4aaxrsIhD1Nv8Ux91SZVItmqQiXzkX8OQJF3qqWhuDlejxSnc-8ab37PPj76Cl_e5WowtV9fzXtsJ7WA-f7Fkrvc-kmxU44UbuNBVsGd5bjg_hlyAuICSVovfo33Qg_BSnXEuWP94wLWYP33yvvSFuk_VcQWsiiQ8NZ_Uve7C0KEdHr8ZzO5ukno_tMcpwLMf3-jISN8Zgg5nNlG4T9bzlvZCdjHx9pSwx5MqohafA3IOL0wbVpXNEHiJEUwscyv5YyeAsO0gtNoDpMnWQt0ht3OsnT-Mz7xnmIjvaW17mxNysUEBefhsVc0VHaviVUkZcxNuoHT5nphUWdvlWuyloyvFjkTujsxFWkNd_DVxdCyxGE99WxAGmlcXbpqqoRcNC32I0RyRqb274qKN3pVegJJnfzg9-YcgqO8lUFG_i2zQLwPhjcKhKgeGGX4eQhUq9qeHVqJEh7PvQebdqy2qqXonmaOZpj0o2UObZVmikQeuCRxJURIr200sRD7P3D3llRAH9pdJg0gbPS6HUkZpZU18dZO0iQsIMq0QX6Q9oiWr2hD8HT0W8W_EO7W2JjVqUYTspmHG_neKoDjJmIJjg0wng4NTLwnthyiSrF7gNS8jBf97nJdLQzfd-jXJ-70yRb64AKHKl4gYBP1RYWF4dNAQQZTQG7U-ZMytC73xbxXcznY5tAX5jeAbjOLuFtlZeoXrR1PDtAVjHFaczVIgKeFMh9aj8dcRV44-AIXk";

    const API_LIST = "https://api.dropboxapi.com/2/files/list_folder";
    const API_CONTINUE = "https://api.dropboxapi.com/2/files/list_folder/continue";
    const API_DOWNLOAD = "https://content.dropboxapi.com/2/files/download";

    // ç¾åœ¨ã®ãƒ‘ã‚¹ã€‚App folder ã®ãƒ«ãƒ¼ãƒˆã¯ç©ºæ–‡å­— "" ã§ã™ã€‚UIã§ã¯ "/" ã¨ã—ã¦è¡¨ç¤ºã—ã¾ã™ã€‚
    let currentPath = "";

    document.getElementById("up-btn").addEventListener("click", () => {
      if (!currentPath) return; // ãƒ«ãƒ¼ãƒˆãªã‚‰ç„¡è¦–
      currentPath = parentPath(currentPath);
      listFolder(currentPath);
    });

    function parentPath(path) {
      // path ã¯ "/ãƒ•ã‚©ãƒ«ãƒ€/..." ã®å½¢ã‚’æƒ³å®šã€‚ç©ºãªã‚‰ç©ºã‚’è¿”ã™ã€‚
      if (!path) return "";
      const parts = path.split("/").filter(Boolean); // leading/trailing ã®ç©ºè¦ç´ ã‚’é™¤å»
      parts.pop();
      return parts.length ? "/" + parts.join("/") : "";
    }

    function displayPath(path) {
      document.getElementById("current-path").textContent = path ? path : "/";
    }

    async function listFolder(path = "") {
      // UI ã‚’ã‚¯ãƒªã‚¢
      const list = document.getElementById("file-list");
      list.innerHTML = "<li class='small'>èª­ã¿è¾¼ã¿ä¸­â€¦</li>";
      displayPath(path);

      let entries = [];
      try {
        // åˆå› list_folder
        let res = await fetch(API_LIST, {
          method: "POST",
          headers: {
            "Authorization": "Bearer " + ACCESS_TOKEN,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ path: path, include_non_downloadable_files: false })
        });
        let data = await res.json();
        if (data.error) throw data;
        entries = entries.concat(data.entries || []);

        // ãƒšãƒ¼ã‚¸ãƒ³ã‚°ãŒã‚ã‚‹å ´åˆã¯ç¶šã‘ã¦å–å¾—
        while (data.has_more) {
          res = await fetch(API_CONTINUE, {
            method: "POST",
            headers: {
              "Authorization": "Bearer " + ACCESS_TOKEN,
              "Content-Type": "application/json"
            },
            body: JSON.stringify({ cursor: data.cursor })
          });
          data = await res.json();
          if (data.error) throw data;
          entries = entries.concat(data.entries || []);
        }
      } catch (err) {
        console.error(err);
        list.innerHTML = "<li class='small'>ãƒ•ã‚©ãƒ«ãƒ€ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</li>";
        return;
      }

      // ãƒ•ã‚©ãƒ«ãƒ€ã‚’å…ˆã«ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¾Œã«è¡¨ç¤º
      const folders = entries.filter(e => e[".tag"] === "folder");
      const files = entries.filter(e => e[".tag"] === "file");

      list.innerHTML = "";

      if (folders.length === 0 && files.length === 0) {
        list.innerHTML = "<li class='small'>ã“ã®ãƒ•ã‚©ãƒ«ãƒ€ã¯ç©ºã§ã™ã€‚</li>";
        return;
      }

      folders.forEach(folder => {
        const li = document.createElement("li");
        const a = document.createElement("a");
        a.textContent = "ğŸ“ " + folder.name;
        a.className = "folder";
        a.onclick = () => {
          // ãƒ•ã‚©ãƒ«ãƒ€ã‚’é–‹ãã€‚folder.path_display ã‚’ä½¿ã†
          currentPath = folder.path_display || folder.path_lower || ("/" + folder.name);
          listFolder(currentPath);
        };
        li.appendChild(a);
        list.appendChild(li);
      });

      files.forEach(file => {
        const li = document.createElement("li");
        const ext = (file.name.split(".").pop() || "").toLowerCase();
        const a = document.createElement("a");
        a.textContent = (ext === "mp4" ? "ğŸï¸ " : "ğŸ“„ ") + file.name;

        a.onclick = async () => {
          // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦é–‹ãï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã§å†ç”Ÿ / ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰
          try {
            const res = await fetch(API_DOWNLOAD, {
              method: "POST",
              headers: {
                "Authorization": "Bearer " + ACCESS_TOKEN,
                // Dropbox ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ API ã«ã¯ path ã‹ id ã‚’æŒ‡å®šï¼ˆpath_display ã‚’ä½¿ã†ï¼‰
                "Dropbox-API-Arg": JSON.stringify({ path: file.path_display || file.path_lower })
              }
            });
            if (!res.ok) throw new Error("ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¤±æ•—: " + res.status);
            const blob = await res.blob();
            const url = URL.createObjectURL(blob);

            if (ext === "mp4") {
              // mp4 ã¯æ–°ã—ã„ã‚¿ãƒ–ã§å†ç”Ÿ
              window.open(url, "_blank");
            } else {
              // ãã‚Œä»¥å¤–ã¯ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆ.onnx ç­‰ï¼‰
              const dl = document.createElement("a");
              dl.href = url;
              dl.download = file.name;
              document.body.appendChild(dl);
              dl.click();
              dl.remove();
              // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆURLã¯å¾Œã§è§£æ”¾ï¼ˆçŸ­æ™‚é–“ã§ååˆ†ï¼‰
              setTimeout(() => URL.revokeObjectURL(url), 60_000);
            }
          } catch (e) {
            console.error(e);
            alert("ãƒ•ã‚¡ã‚¤ãƒ«å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
          }
        };

        li.appendChild(a);
        list.appendChild(li);
      });
    }

    // æœ€åˆã«ãƒ«ãƒ¼ãƒˆã‚’è¡¨ç¤ºï¼ˆApp folder ã®ãƒ«ãƒ¼ãƒˆã¯ ""ï¼‰
    listFolder("");
  </script>
</body>
</html>