<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ModelVault Viewer</title>
  <style>
    body { font-family: sans-serif; }
    ul { list-style: none; padding: 0; }
    li { padding: 5px; cursor: pointer; }
    li.folder { font-weight: bold; color: darkgreen; }
    li.file { color: blue; }
    #backBtn { margin-bottom: 10px; display:none; }
  </style>
</head>
<body>
  <h1>Dropbox ファイル一覧</h1>
  <button id="backBtn">戻る</button>
  <ul id="file-list"></ul>
  <video id="videoPlayer" width="640" height="360" controls style="display:none; margin-top:1em;"></video>

  <script>
    const ACCESS_TOKEN = "sl.u.AGCYvAGJm_1hk8HhIVoWKVQ1GNJs6v7DqDA6iE2WdFeM4-QYBE2A8409Puty89yYWDJGqFWAWo-lldQS6oBos6TuqduamBHpyklyshp0CnfWTLFZhqVax6YXJoiTqKBrpCQfBwQc3VfVOkOpH2gW9dkUsg9Zx9nySi2Cxi3prjUuXlOUc3pP_1CHIObXMrJx7eNHpcyQYbdeinRRjnB22h_SlemZjvTfSf_nuCW83Yh6oii9f3iXYh0Zs7hnkm6z0tfzm0VNY-KXis5ChxwNrp89-mO_szk1PWROXbHpEnKALS1tdnuhSRVlH_OZc22l4bqZpKxwljpg4a-MyAvm9IBtZsjSTHANX7w570ek7AQv_GJurNxPJTSQXt9Kh0ClSGC_tkq0biId674_fP0M8FyEXMLeZWAiIZtcTGB1RY4Oxs3wGZz0w99MqM-Tl19KeWC7dBVEDxkt_D9OD7LsP2CB_caUe4Xw4w_3P1U3lSQ1_gW32e-tRua5fvrwqiVp5H3J3eMLiYUomtiWPRWfOLENOp-3d75Nk4lPlVrS9Dlv8nKvbehi4gPR5fHDGpYqgIkVqR9p0Bg7i4pdvfXkLdx5GLx4e-_GzgUbUZQRwLLKE5sdP3zzqQ-vIdbrFIi3P0UC26LJDWYpUqr0b-nHr68EK-jU_7CNOC6U1mhz-RRxwA7uuY0Hdk_BCNg_-GiqNBpCfR3V1Hx2XZOVW5Ev2zdCVukJ2e3pvJqQxq0d33lCUSr4GNEAe_O9mx2WNcqB8tzdgcVQACZ6u2jP5iuJq6BteGUnRtniGCxa_ihjafKBB0mHuzMfB3C4WO-WEYSjCiB_zl-R_lr7ivBfF5lfUv8Yu3ClhEPLeleJHbh2w8xcVOjkNblSDZmTk88VZKRif4ILT4u0v_KA__uMiAOoC0v5yhBVHpPgmUzaemLpbW_iCp0LCd7kC7oqCMkz-sJyHSGZEphaTy_ZLAiog-31YD3gEV9GnD6qy9-0kGGwxrMpbkBcX1KkJhGGjluUXSoWAYQPfbKK0342iRbDZFqo7Nc9vbNeUBYVrve8DDGLrUhWTsdeYRrNKnSoi10R-JI4GFz9SFTwtl7wmtUisN0ts4XHqb_BtK8Qcbpx3D_i5ikBqiD9McPm3LF6GyPeifzigSg5zsXZeQD392P4Vl4c-omOdP7gOu5EB0942dgb8Lh1B2opnU5j_CKpKvnY-f46XtKTwRY8Em-hOU1nV4mDW5j97LfXnfmHNtP6CpGVdleplQcvHGSz-Ieu6-r-pifFXpQ"; 
    const LIST_API = "https://api.dropboxapi.com/2/files/list_folder";
    const TEMP_LINK_API = "https://api.dropboxapi.com/2/files/get_temporary_link";

    // 📂 現在のパスを管理（戻る機能用）
    let pathHistory = [];

    async function fetchFiles(path = "") {
      // ✅ フォルダを開いたら動画を止める
      const videoPlayer = document.getElementById("videoPlayer");
      videoPlayer.pause();
      videoPlayer.src = "";
      videoPlayer.style.display = "none";

      const response = await fetch(LIST_API, {
        method: "POST",
        headers: {
          "Authorization": "Bearer " + ACCESS_TOKEN,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ path })
      });
      const data = await response.json();

      const list = document.getElementById("file-list");
      list.innerHTML = ""; // 前回のリストをクリア

      // 戻るボタンの表示制御
      const backBtn = document.getElementById("backBtn");
      backBtn.style.display = pathHistory.length > 0 ? "inline-block" : "none";

      data.entries.forEach(entry => {
        const li = document.createElement("li");
        li.textContent = entry.name;

        if(entry[".tag"] === "folder") {
          li.classList.add("folder");
          li.onclick = () => {
            pathHistory.push(path); // 現在のパスを記録
            fetchFiles(entry.path_lower);
          };
        } else if(entry[".tag"] === "file" && entry.name.endsWith(".mp4")) {
          li.classList.add("file");
          li.onclick = () => playVideo(entry.path_lower);
        }

        list.appendChild(li);
      });
    }

    async function playVideo(path) {
      const response = await fetch(TEMP_LINK_API, {
        method: "POST",
        headers: {
          "Authorization": "Bearer " + ACCESS_TOKEN,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ path })
      });

      const data = await response.json();
      const videoUrl = data.link;

      const videoPlayer = document.getElementById("videoPlayer");
      videoPlayer.src = videoUrl;
      videoPlayer.style.display = "block";
      videoPlayer.play();
    }

    // 戻るボタンの処理
    document.getElementById("backBtn").onclick = () => {
      if (pathHistory.length > 0) {
        const prevPath = pathHistory.pop(); // 一つ前のパスを取り出す
        fetchFiles(prevPath);
      }
    };

    // 初回呼び出し（ルートフォルダ表示）
    fetchFiles();
  </script>
</body>
</html>
